# ReSoCa protocoll documentation

---

## Overview

The client and server communicate by sending lenght-prefixed Protobuf messages.

More specifically, a 16-bit unsigned short, with LSB-endianness is sent before
the protobuf message, which may be at most 1024 bytes long.

The Protobuf message format is defined in `src/shared/protobuf/ResocaMessage.proto`.

## Messages

The Message being sent is of type `ResocaMessage`, also referred to as the "root message".

There are two message types, Request and Response. Which one the message contains,
is denoted by the `isResponse` boolean.

Depending on the state of this field, there is either a `request` or `response`
submessage in the root message.

### Request

The message type is decided by the value of the `requestType` enum.

### RequestTypes

Valid types and their purpose are:


| Enum ID | Name | Purpose | Required Fields | Optional Fields |
| ------- | ---- | ------- | --------------- | ----------------|
| 0 | `PING` | Request to send a `PONG` message with the same `responseID` as the `requestID` of this message | `requestID` | - |
| 1 | NOTIFY_START | Request that messages relevant to `ifName` be sent to the client | `requestID`, `ifName` | - |
| 2 | NOTIFY_END | Request that messages relevant to `ifName` be no longer sent | `requestID`, `ifName` | - |
| 3 | CAN_TX | Send `canFrame` on `ifName` | `requestID`, `ifName`, `canFrame` | - |
| 4 | CAN_STAT | Request statistics for CAN bus `ifName` | `requestID`,`ifName` | - |
| 5 | INFO | Request information about the sever | - | - |

### ResponseTypes

| Enum ID | Name | Purpose | Required Fields | Optional Fields | Used for Request |
| ---| --- | --- | --- | --- | --- | 
| 0 | ACK | To acknowledge a Message has been processed, but not yet executed | `responseID` | `ifName`, `description` | upon CAN_TX |
| 1 | SUCCESS | To indicate an operation occured successfully | `responseID` | `description`, `canFrame` | upon successful completion of an operation without specific responseType |
| 2 | ERR | To indicate an operation failed | - | `responseID`, `description` | all |
| 3 | PONG | A reply to the `PING` command | `responseID` | - | `PING` |
| 4 | CAN_RX | CAN message received | `ifNamse`, `canFrame` | - | - |
| 5 | CAN_STAT | Statistics about CAN device `ifName` | `responseID`, `IfInfo` | - | CAN_STAT |
| 6 | INFO | Information about the server | `responseID`, `resocaInfo` | - | `INFO` |

## Communication

 The client MUST send an `INFO`-request message first, in which it shall receive a `sessionPrefix`, which it MUST use to generate it's further `requestIDs`.

`requestIDs` are used by the client to keep track of pending messages.
They are computed by ANDing a unique number generated by the client with the `sessionPrefix` provided in the `INFO` response.
